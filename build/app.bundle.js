!function(e){var s={};function t(r){if(s[r])return s[r].exports;var o=s[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=s,t.d=function(e,s,r){t.o(e,s)||Object.defineProperty(e,s,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,s){if(1&s&&(e=t(e)),8&s)return e;if(4&s&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&s&&"string"!=typeof e)for(var o in e)t.d(r,o,function(s){return e[s]}.bind(null,o));return r},t.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(s,"a",s),s},t.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},t.p="",t(t.s=14)}([function(e,s,t){t(13).config();var r=t(2);const o={IP:process.env.SERVER_IP,HTTP_SERVER_PORT:process.env.HTTP_LOCAL_PORT||8001,HTTPS_SERVER_PORT:process.env.HTTPS_LOCAL_PORT||8443,secret:"thequickfoxjumpedoverthelazydog",geo_url:"https://maps.googleapis.com/maps/api/geocode/json",geo_key:process.env.GOOGLE_KEYS,prepare:!0},n=new r(process.env.DB_NAME||"MEDWING_TEST",process.env.DB_USER||"medwing_admin",process.env.DB_PASSWORD||"pa55w0rd",{host:process.env.DB_HOST||"localhost",dialect:process.env.DB_DIALECT||"mysql",pool:{max:1,min:0,idle:1e4,acquire:2e4,handleDisconnects:!0}});e.exports={config:o,sequelize:n}},function(e,s){e.exports=require("express")},function(e,s){e.exports=require("sequelize")},function(e,s){e.exports=require("jsonwebtoken")},function(e,s){e.exports=require("axios")},function(e,s){e.exports=require("body-parser")},function(e,s){e.exports=require("cookie-parser")},function(e,s){e.exports=require("morgan")},function(e,s){e.exports=require("express-session")},function(e,s){e.exports=require("cors")},function(e,s){e.exports=require("compression")},function(e,s){e.exports=require("http")},function(e){e.exports=[{name:"John Doe",avatar:"john.png"},{name:"Jane Smith",avatar:"jane.png"}]},function(e,s){e.exports=require("dotenv")},function(e,s,t){"use strict";t.r(s);var r=t(1),o=t.n(r),n=t(6),a=t.n(n),i=t(5),c=t.n(i),u=t(7),d=t.n(u),l=t(8),g=t.n(l),f=t(0),p=t(3),h=t.n(p),m=t(9),w=t.n(m),y=t(10),_=t.n(y),v=t(11),q=t.n(v),E=t(2);class S{model(e){return e.define("user",{name:{type:E.Sequelize.STRING},avatar:{type:E.Sequelize.STRING},status:{type:E.Sequelize.ENUM,values:["A","D"],defaultValue:["A"]}},{underscored:!0})}}class j{model(e){return e.define("location",{user_id:{type:E.Sequelize.INTEGER},title:{type:E.Sequelize.STRING},address:{type:E.Sequelize.STRING},lat:{type:E.Sequelize.STRING},lng:{type:E.Sequelize.STRING},status:{type:E.Sequelize.ENUM,values:["A","D"],defaultValue:["A"]}},{underscored:!0})}}class b{constructor(e){this.UserModel=e}routes(){const e=o.a.Router();return e.route("/user_id/:id").get((e,s)=>{const t=e.params.id;try{if(!Number.isInteger(parseInt(t)))throw new Error("invalid user_id");this.generateSession(s,t)}catch(e){s.status(400).json({success:!1,message:e.message})}}),e}async generateSession(e,s){const t=await this.UserModel.findOne({where:{id:s,status:"A"}});if(t){const s=h.a.sign({user:t},f.config.secret,{expiresIn:"10d"});e.status(200).json({success:!0,results:{user_id:t.id,username:t.name.split(" ")[0],token:s,keys:f.config.geo_key}})}else e.status(400).json({success:!1,message:"invalid user"})}}const T=0,L=1;var x=t(4),R=t.n(x);class P{isValidGeoLocation(e,s,t){return new Promise(async r=>{const{geo_url:o,geo_key:n}=f.config;try{const a=await R.a.get(o,{params:{key:n,address:e}});if(!a.data.results.length)return r({success:!1,code:L});const{lat:i,lng:c}=a.data.results[0].geometry.location,u=a.data.results[0].formatted_address,d=s.toString().substr(0,4),l=t.toString().substr(0,t.toString().includes("-")?5:4);return u.toLowerCase().includes(e.toLowerCase())||i.toString().includes(d)||c.toString().includes(l)?r({success:!0,address:u,lat:i,lng:c}):r({success:!1,address:u,lat:i,lng:c,code:L})}catch(e){return r({success:!1,code:T})}})}getGeoLocationByAddress(e){return new Promise(async s=>{const{geo_url:t,geo_key:r}=f.config;try{const o=await R.a.get(t,{params:{key:r,address:e}});if(!o.data.results.length)return s({success:!1,code:L});const n=o.data.results[0].formatted_address,{lat:a,lng:i}=o.data.results[0].geometry.location;return s({success:!0,address:n,lat:a,lng:i})}catch(e){return s({success:!1,code:T})}})}getGeoLocationByPoint(e,s){return new Promise(async t=>{const{geo_url:r,geo_key:o}=f.config;try{const n=await R.a.get(r,{params:{key:o,latlng:e+","+s}});if(!n.data.results.length)return t({success:!1,code:L});const a=n.data.results[0].formatted_address,{lat:i,lng:c}=n.data.results[0].geometry.location;return t({success:!0,address:a,lat:i,lng:c})}catch(e){return t({success:!1,code:T})}})}}class I{constructor(e,s){this.UserModel=e,this.LocationModel=s,this.geo=new P}routes(){const e=o.a.Router();return e.route("/").get((e,s)=>{const t=e.query.user_id;Number.isInteger(parseInt(t))&&this.fetchLocations(s,t)}),e.route("/:id").put((e,s)=>{const{id:t}=e.params,{user_id:r,title:o,address:n,lat:a,lng:i}=e.body;try{if(!Number.isInteger(parseInt(t)))throw new Error("invalid location_id");if(!r)throw new Error("user_id required");if(!o)throw new Error("title required");if(!n)throw new Error("address required");if(!a)throw new Error("lat required");if(!i)throw new Error("lat required");this.updateLocation(s,t,e.body)}catch(e){s.status(400).json({success:!1,message:e.message})}}),e.route("/:id").delete((e,s)=>{const t=e.params.id,r=e.query.user_id||e.body.user_id;try{if(!r)throw new Error("user_id is required");if(!Number.isInteger(parseInt(r)))throw new Error("invalid user_id");if(!Number.isInteger(parseInt(t)))throw new Error("invalid location_id");this.deleteLocation(s,t,r)}catch(e){s.status(400).json({success:!1,message:e.message})}}),e.route("/").post((e,s)=>{try{if(!Number.isInteger(parseInt(e.body.user_id)))throw new Error("user_id is required");if(!e.body.address)throw new Error("address is required");if(!e.body.title)throw new Error("title is required");if(!e.body.lat)throw new Error("lat is required");if(!e.body.lng)throw new Error("lng is required");this.saveLocation(s,e.body)}catch(e){s.status(400).json({success:!1,message:e.message})}}),e}async updateLocation(e,s,t){try{if(!await this.LocationModel.findOne({where:{id:s,user_id:t.user_id,status:"A"}}))throw new Error("user not associated with location");const r=await this.geo.isValidGeoLocation(t.address,t.lat,t.lng);if(!r.success)throw new Error("invalid address pairs");const{address:o,lat:n,lng:a}=r;if(!await this.LocationModel.update({address:o,lat:n,lng:a,title:t.title},{where:{id:s,status:"A"}}))throw new Error("update was unsuccessful");e.status(200).json({success:!0,message:"update completed successfully"})}catch(s){e.status(400).json({success:!1,message:s.message})}}async saveLocation(e,s){try{if(!await this.UserModel.findOne({where:{id:s.user_id,status:"A"}}))throw new Error("user does not exist");const{address:t,lat:r,lng:o}=s,n=await this.geo.isValidGeoLocation(t,r,o);if(!n.success&&n.code===L)return void e.status(200).json({success:!1,code:L,message:"No location found"});const{address:a,lat:i,lng:c}=n,{title:u,user_id:d}=s;await this.LocationModel.create({address:a,lat:i,lng:c,title:u,user_id:d}),e.status(200).json({success:!0,message:"location added successfully"})}catch(s){e.status(400).json({success:!1,message:s.message})}}async fetchLocations(e,s){const t=await this.LocationModel.findAll({where:{user_id:s,status:"A"}});t?e.status(200).json({success:!0,results:t,message:"request successful"}):e.status(400).json({success:!1,message:"request not succesful"})}async deleteLocation(e,s,t){try{if(!await this.LocationModel.update({status:"D"},{where:{id:s,user_id:t,status:"A"}}))throw new Error("delete request not successful");e.status(200).json({success:!0,message:"delete request successful"})}catch(s){e.status(400).json({success:!1,message:s.message})}}}class A{constructor(e){this.UserModel=e}routes(){const e=this,s=o.a.Router();return s.route("/").get((s,t)=>{e.fetchAllUsers(t)}),s.route("/:id").get((s,t)=>{const r=parseInt(s.params.id);try{if(!Number.isInteger(r))throw new Error("invalid id input");e.fetchUser(r)}catch(e){t.status(400).json({success:!1,message:e.message})}}),s}async fetchAllUsers(e){const{IP:s,HTTP_SERVER_PORT:t}=f.config,r=s+":"+t+"/resources/images/",o=(await this.UserModel.findAll()).map(e=>(e.avatar=r+e.avatar,e));e.status(200).json({success:!0,results:o})}async fetchUser(e,s){const t=await this.UserModel.findOne({where:{id:s,status:"A"}});t?e.status(200).json({success:!0,results:t,message:"successful request"}):e.status(400).json({success:!1,message:"user does not exist"})}}class k{constructor(){this.geo=new P}routes(){const e=this,s=o.a.Router();return s.route("/search").get((s,t)=>{const{address:r,lat:o,lng:n}=s.query;r?e.searchByAddress(t,r):o&&n&&e.searchByPoint(t,o,n)}),s}async searchByAddress(e,s){try{const t=await this.geo.getGeoLocationByAddress(s);if(!t.success&&t.code===L)return void e.status(200).json({success:!1,code:L,message:"No location found"});if(!t.success&&t.code===T)return void e.status(200).json({success:!1,code:T,message:"Third party down"});const{lat:r,lng:o,address:n}=t;e.status(200).json({success:!0,results:{query:s,address:n,lat:r,lng:o},message:"request successful"})}catch(s){e.status(400).json({success:!1,message:s.message})}}async searchByPoint(e,s,t){try{const r=await this.geo.getGeoLocationByPoint(s,t);if(!r.success)throw new Error("no location found");const{lat:o,lng:n,address:a}=r;e.status(200).json({success:!0,results:{address:a,lat:o,lng:n},message:"request successful"})}catch(s){e.status(400).json({success:!1,message:s.message})}}}var O=t(12);class M{constructor(e){this.UserModel=e}async initDB(){const e=this;O.map(async s=>{await e.UserModel.create({name:s.name,avatar:s.avatar})})}isValidToken(e){const s=o()();s.set("token",f.config.secret),h.a.verify(e,s.get("token"),function(e,s){return!e})}}t.d(s,"default",function(){return N});class N{constructor(){this.app=o()(),this.initExpress(this.app),this.initSQLAndRouters(this.app),this.finalize(this.app)}initExpress(e){e.use(c.a.json({limit:"50mb",parameterLimit:1e6})),e.use(c.a.urlencoded({limit:"50mb",extended:!0,parameterLimit:1e6})),e.use(a()()),e.use(_()()),e.use(g()({resave:!0,saveUninitialized:!0,secret:f.config.secret,cookieName:"session",duration:18e5,activeDuration:3e5,httpOnly:!0,cookie:{secure:!1}})),e.use(d()("dev")),e.use(o.a.static("build")),e.use((e,s,t)=>{s.header("Cache-Control","private, no-cache, no-store, must-revalidate"),s.header("Expires","-1"),s.header("Pragma","no-cache"),t()}),e.use(w()())}validate(e,s,t){const r=o()();r.set("token",f.config.secret);const n=e.body.token||e.query.token||e.headers["x-access-token"];if(!n)return s.status(403).send({success:!1,message:"No token provided."});h.a.verify(n,r.get("token"),e=>e?s.json({success:!1,message:"Failed to authenticate token."}):t())}async initSQLAndRouters(e){const s=f.sequelize,t=(new j).model(s),r=(new S).model(s);t.belongsTo(r);const o=new I(r,t),n=new A(r),a=new b(r),i=new k;if(f.config.prepare){await s.drop(),await s.sync({force:!0}),new M(r).initDB()}else await s.sync();e.use("/medwing/api/v1/*",this.validate),e.use("/medwing/api/v1/locations",o.routes()),e.use("/medwing/api/v1/geocoding",i.routes()),e.use("/medwing/api/sessions",a.routes()),e.use("/medwing/api/users",n.routes())}finalize(e){const s=f.config.HTTP_SERVER_PORT;q.a.createServer(e).listen(s)}}new N}]);